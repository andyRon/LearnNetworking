# 《Wireshark网络分析从入门到实践》

任何的网络攻击行为最终都是通过发送数据包来实现的，如果我们从数据包这个层次来分析问题，一切就会清晰起来。

Wireshark的两个重要作用：网络故障，网络安全。

2023 Version 4.0.3

## 1 走进Wireshark

“网络显微镜”：TcpDump（没有图形界面）、Sniffer、Ethereal和Wireshark等

### 1.1 Wireshark是什么

Wireshark是一个可以运行在各种主流操作系统上的**数据包分析软件**。

#### Wireshark的功能

现代网络，”**分组交换**“（将较大的信息拆分成基本单元），基本单元就是数据包 =包头+包体，包头是源地址和目标地址。

应用程序和操作系统在产生了数据包之后，会发送到网卡，然后再由网卡交给网络中的设备发送出去。

一般网卡在对接收到的数据包进行处理之前，会先对它们的目的地址进行检查，如果目的地址不是本机的话，就会丢弃这些数据，相反就会将这些数据包交给操作系统，操作系统再将其分配给应用程序。

1. 如果使用了Wireshark的话，那么网卡无论是接收还是发送数据包的时候，都会将这些数据包**复制**一份发送给Wireshark。这个获取流经网卡数据包的过程，也被称为“捕获数据包”或者简称为“**抓包**”。
2. Wireshark可以将捕获到的数据包进行自动分析，把这些0和1的组合解析成我们容易理解的形式，这个过程就是“**数据包分析**”。

#### Wireshark的历史

Gerald Combs，1998-7 Ethereal -> Wireshark，

#### Wireshark的工作原理

网卡两种工作方式：

**普通模式**：只会将发给本机的数据包传递给操作系统，其他的一律丢弃。

**混杂模式**：会将所有通过它的数据包（不管是不是发给本机）都传递给操作系统。Wireshark经常使用混杂模式

Wireshark的工作流程：

1. 捕获：Wireshark将网卡调整为混杂模式，在该模式下捕获网络中传输的二进制数据。
2. 转换：Wireshark将捕获到的二进制数据转换为我们容易理解的形式，同时也会将捕获到的数据包按照顺序进行组装。
3. 分析：最后Wireshark将会对捕获到的数据包进行分析。这些分析包括识别数据包所使用的协议类型、源地址、目的地址、源端口和目的端口等。Wireshark有时也会根据自带的协议解析器来深入地分析数据包的内容。

#### Wireshark的优势

1. 所有主流操作系统都可运行
2. 支持更多的网络协议
3. 极为友好的使用界面
4. 对网络数据实时的显示
5. 开源项目（C语言）



### 1.2 安装

WinPcap

**ChmodBPF**

### 1.3 一次完整的Wireshark使用过程

1. 选择合适的网卡

Wireshark的启动界面中列出了**当前计算机上所有网卡设备的名称以及流经该网卡的数据包信息**。（每个网卡后面以曲线图的形式展示数据包的数量）

捕获选项：

![](./images/image-20230121143506931.png)

![](./images/image-20230122153839478.png)

![](images/image-20230121143629259.png)





2. 开始数据包的捕获

在进行数据包捕获时的工作界面：

![](images/Untitled.png)

> 1: 标题栏
>
> 2: 菜单栏
>
> 3: 工具栏
>
> 4：<font color=#FF8C00>显示过滤器</font>，它的作用是将捕获的所有流量进行筛选，过滤掉不需要的流量。
> 5：数据包列表面板；每一行表示一个捕获到的数据包，每一列表示数据包的特定信息，如下
> No：按顺序的唯一标识数据包的序列号。
> Time：捕获数据包时的时间戳。
> Source：捕获数据包的源IP地址。
> Destionation：捕获数据包的目的IP地址。
> Protocol：捕获数据包的协议类型。
> Length：捕获数据包的大小。
> Info：数据包的附加信息。
> 6：数据包细节面板。
> 7：数据包字节面板。左侧灰色的第1列表示数据的偏移量。第2列是以十六进制表示的数据包内容，第3列是以ASCII码表示的数据包内容。
>
> 8：状态条
3. 过滤无用的数据

**会话统计功能**：将相同的源地址和目的地址（例如192.168.0.1到1.1.1.1）之间的所有数据包看作是一个对话。**统计→会话（对话，Conversations）**

![](images/Untitled%201.png)

- Address A：该次对话的A地址。
- Address B：该次对话的B地址。
- Packets：该对话中的数据包数量。
- Bytes：该对话中产生全部数据包的大小。
- Packets A→B：从A地址发往B地址数据包的数量。
- Bytes A→B：从A地址发往B地址数据包的大小之和。
- Packets B→A：从B地址发往A地址数据包的数量。
- Bytes B→A：从B地址发往A地址数据包的大小之和。
- Rel Start：这个值表示的是从Wireshark开始捕获数据包到对话建立之间的时间间隔。
- Duration：这个对话建立的时间。
- Bits/s A→B：这个对话从A到B每秒钟平均网络流量。
- Bits/s B→A：这个对话从B到A每秒钟平均网络流量。

**名字解析**：把IP地址解析为域名（一般在数据捕获结束后启用，减轻捕获时的压力）。**“视图”→“解析名称”→“解析网络地址”。**此时在数据包列表面板会显示域名，在会话列表左下角勾选**解析名称**也可以看到域名。

**过滤功能**

![](images/Untitled%202.png)

![](images/Untitled%203.png)

4. 将捕获到的数据包保存到文件

**“文件”→“导出特定分组”**

![](images/Untitled%204.png)

## 2 过滤无用的数据包

在实际工作中，对Wireshark过滤器的使用也很能看出一个工作人员的基本功。

### 2.1 伯克利包过滤

伯克利包过滤（Berkeley Packet Filter，BPF），采用了一种与自然语言很接近的语法，利用这种语法构成的字符串可以确定保留哪些数据包以及忽略掉哪些数据包。

<font color=#FF8C00>原语</font> + <font color=#FF8C00>限定符</font>

限定符有3中：

1. type：表示指代的对象，例如IP地址、子网或者端口等。常见的有host（用来表示主机名和IP地址）、net（用来表示子网）、port（用来表示端口）。如果没有指定的话，就默认为host。
2. dir：表示数据包传输的方向，常见的有src（源地址）和dst（目的地址）。如果没有指定的话，默认为“src or dst”。例如“192.168.1.1”就表示无论源地址或者目的地址为192.168.1.1的都使得这个语句为真。
3. proto：表示与数据包匹配的协议类型，常见的就是ether、ip、tcp、arp这些协议。

